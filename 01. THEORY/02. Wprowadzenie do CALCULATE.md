# Wprowadzenie do CALCULATE

## Czym jest `CALCULATE` i dlaczego jest najważniejsza w DAX

**CALCULATE** to najpotężniejsza funkcja w języku DAX. Pozwala ona **modyfikować kontekst filtrów**, w którym obliczana jest miara.

### Dlaczego `CALCULATE` jest tak ważna?

W poprzednim rozdziale nauczyliśmy się, że miary obliczają się dynamicznie w zależności od kontekstu filtrów. Funkcja CALCULATE pozwala:

✓ **Nadpisać** istniejące filtry ✓ **Dodać** nowe filtry ✓ **Usunąć** filtry ✓ **Zmienić** sposób działania kontekstu

**Innymi słowy:** CALCULATE daje Ci pełną kontrolę nad tym, na jakich danych oblicza się Twoja miara.

### Podstawowa składnia

```dax
CALCULATE(
    <wyrażenie>,
    <filtr1>,
    <filtr2>,
    ...
)
```

- **wyrażenie** - miara lub wyrażenie do obliczenia
- **filtr1, filtr2, ...** - filtry, które mają być zastosowane

---

## Czym jest kontekst filtrowania?

**Kontekst filtrowania** to zbiór filtrów aktywnych w danym momencie obliczeń. Określa on **jakie wiersze** z tabel są brane pod uwagę.

**Przykład:** Jeśli na wizualizację naniesiesz kolumnę `Rok - Miesiac` i miarę `Sprzedaż Netto`, to

- `Rok - Miesiac` staję się **kontekstem filtrowania**
- Więc miara `Sprzedaż Netto` jest obliczana **w kontekście kolumn** `Rok - Miesiac` ![[Pasted image 20251209173843.png]]

> W Power BI często określa się to terminami: kontekstu, filtra lub kontekstu filtra - można stosować je niemalże zamiennie

---

## Użycie `CALCULATE`

### Przykład 1: Dodanie filtra

```dax
Sprzedaż Netto - Napoje =
CALCULATE(
    [Sprzedaż Netto],
    dKategorie[Kategoria] = "NAPOJE"
)
```

**Co się dzieje:**

- Bierze miarę `[Sprzedaż Netto]`
- Dodaje filtr: tylko dla kategorii "NAPOJE"
- Zwraca sumę tylko dla napojów ![[Pasted image 20251209172007.png]]

---

### Przykład 2: Wiele filtrów

```dax
Sprzedaż VIP w 2024 = 
CALCULATE(
    [Sprzedaż Netto],
    dKlienci[Kategoria] = "VIP",
    YEAR(dKalendarz[Data]) = 2024
)
```

**Filtry są łączone operatorem AND** – muszą być **oba** spełnione.

![[Pasted image 20251209172247.png]]

---

### Przykład 3: Nadpisanie istniejącego filtra

A co jeżeli chcemy policzyć udział sprzedaży w sprzedaży ogółem?

- Jeżeli nałożymy na wizualizację kolumnę, tworzy ona kontekst filtra/kolumny
- Do pozbycia się kontekstu służy funkcja `REMOVEFILTERS()`

```dax
Sprzedaż Netto - Cały Okres = 
CALCULATE(
    [Sprzedaż Netto], 
    REMOVEFILTERS(dKalendarz)
)
```

**Co robi `REMOVEFILTERS`?**

- Usuwa filtry z tabeli `dKalendarz`
- Dzięki temu `Sprzedaż Netto - Cały Okres` pokazuje sumę dla **wszystkich dni**, niezależnie od tego, jaki kontekst **Kalendarza** zostanie nałożony na wizualizację

Teraz wystarczy napisać miarę, która podzieli jedną wartość przez drugą.

```dax
Sprzedaż Netto - Udział w Sprzedaży = DIVIDE(
    [Sprzedaż Netto],
    [Sprzedaż Netto - Cały Okres],
    BLANK() -- jeżeli dzielenie przez 0, to zwróć wartość pustą
)
```

![[Pasted image 20251209173050.png]]

> **Ciekawostka:** Funkcję `REMOVEFILTERS()` można używać zamiennie z funkcją `ALL()`. W tym przypadku ich zastosowanie jest identyczne, natomiast `ALL()` ma dodatkowe funkcjonalności, o których później.

---

## Operatory logiczne w `CALCULATE`

Często potrzebujesz zastosować wiele warunków jednocześnie. DAX oferuje kilka sposobów na łączenie warunków.

### Operatory logiczne w DAX

| Operator | Znaczenie           | Przykład                                                                 |
| -------- | ------------------- | ------------------------------------------------------------------------ |
| `=`      | Równe               | `dKategorie[Kategoria] = "NAPOJE"`                                       |
| `<>`     | Różne od            | `dKategorie[Kategoria] <> "NAPOJE"`                                      |
| `>`      | Większe niż         | `fSprzedaz[Kwota] > 50`                                                  |
| `>=`     | Większe lub równe   | `fSprzedaz[Kwota] >= 50`                                                 |
| `<`      | Mniejsze niż        | `fSprzedaz[Kwota] < 100`                                                 |
| `<=`     | Mniejsze lub równe  | `fSprzedaz[Kwota] <= 100`                                                |
| `&&`     | Logiczne AND (i)    | `fSprzedaz[Kwota] > 50 && fSprzedaz[Kwota] < 100`                        |
| `\|`     | Logiczne OR (lub)   | `dKategorie[Kategoria] = "NAPOJE" \| dKategorie[Kategoria] = "SŁODYCZE"` |
| `IN`     | W zestawie wartości | `dKategorie[Kategoria] IN {"NAPOJE", "SŁODYCZE"}`                        |
| `&`      | Łączenie tekstu     | `"Kategoria: " & dKategorie[Kategoria]`                                  |

---

### Operator AND (`&&`)

Używamy gdy **wszystkie** warunki muszą być spełnione jednocześnie.

**Przykład: Sprzedaż w dni robocze**

Załóżmy, że w tabeli dKalendarz mamy kolumnę `DzienTygodnia` (dzień tygodnia: 1 = poniedziałek, ..., 7 = niedziela).

```dax
Sprzedaż Dni Robocze =
CALCULATE(
    [Sprzedaż Netto],
    dKalendarz[DzienTygodnia] >= 1 && dKalendarz[DzienTygodnia] <= 5
)
```

**Warunek:** `DzienTygodnia >= 1` **I** `DzienTygodnia <= 5`

Alternatywna składnia z funkcją AND():

```dax
Sprzedaż Dni Robocze (Alternatywna) =
CALCULATE(
    [Sprzedaż Netto],
    AND(dKalendarz[DzienTygodnia] >= 1, dKalendarz[DzienTygodnia] <= 5)
)
```

---

### Operator OR (`||`)

Używamy gdy **przynajmniej jeden** z warunków musi być spełniony.

**Przykład: Sprzedaż w weekendy**

```dax
Sprzedaż Weekendy =
CALCULATE(
    [Sprzedaż Netto],
    dKalendarz[DzienTygodnia] = 6 || dKalendarz[DzienTygodnia] = 7
)
```

**Warunek:** `DzienTygodnia = 6` **LUB** `DzienTygodnia = 7`

Alternatywna składnia z funkcją OR():

```dax
Sprzedaż Weekendy (Alternatywna) =
CALCULATE(
    [Sprzedaż Netto],
    OR(dKalendarz[DzienTygodnia] = 6, dKalendarz[DzienTygodnia] = 7)
)
```

---

### Operator IN - eleganckie sprawdzanie wielu wartości

Zamiast pisać wielokrotnie OR, użyj operatora `IN`:

```dax
// ✗ Nieeleganckie
Sprzedaż Napoje lub Słodycze =
CALCULATE(
    [Sprzedaż Netto],
    dKategorie[Kategoria] = "NAPOJE" || dKategorie[Kategoria] = "SŁODYCZE"
)

// ✓ Eleganckie
Sprzedaż Napoje lub Słodycze =
CALCULATE(
    [Sprzedaż Netto],
    dKategorie[Kategoria] IN {"NAPOJE", "SŁODYCZE"}
)
```

**Operator IN** sprawdza, czy wartość znajduje się w podanym zestawie.

---

### Łączenie operatorów AND i OR

Możesz łączyć różne operatory:

```dax
Wysoka Sprzedaż Napojów =
CALCULATE(
    [Sprzedaż Netto],
    dKategorie[Kategoria] = "NAPOJE" &&
    fSprzedaz[Kwota] >= 100
)
```

**Warunek:** Kategoria = "NAPOJE" **I** Kwota >= 100

---

## Podsumowanie `CALCULATE`

**CALCULATE** to fundament zaawansowanych obliczeń w DAX:

- Pozwala tworzyć **dynamiczne miary**
- Umożliwia **porównania** między różnymi okresami/kategoriami
- Daje kontrolę nad **kontekstem filtrowania**
- Jest podstawą funkcji time intelligence (SAMEPERIODLASTYEAR, DATEADD, itd.)

**Zapamiętaj:** Jeśli chcesz obliczyć coś w **innym kontekście** niż aktualny, prawdopodobnie potrzebujesz **CALCULATE**.

# Wprowadzenie do CALCULATE

## Czym jest kontekst filtrowania?

**Kontekst filtrowania** to zbiór filtrów aktywnych w danym momencie obliczeń. Określa on **jakie wiersze** z tabel są brane pod uwagę.

**Przykład:** Jeśli na wizualizację naniesiesz kolumnę `Rok - Miesiac` i miarę `Sprzedaż Netto`, to
- `Rok - Miesiac` staję się **kontekstem filtrowania**
- Więc miara `Sprzedaż Netto` jest obliczana **w kontekście kolumn** `Rok - Miesiac`
![[Pasted image 20251209171436.png]]
> W Power BI często określa się to terminami: kontekstu, filtra lub kontekstu filtra - można stosować je niemalże zamiennie

---

##  Użycie CALCULATE

### Przykład 1: Dodanie filtra

```dax
Sprzedaż Netto - Napoje =
CALCULATE(
    [Sprzedaż Netto],
    dKategorie[Kategoria] = "NAPOJE"
)
```

**Co się dzieje:**
- Bierze `SUM(Sprzedaz[Kwota])`
- Dodaje filtr: tylko dla miasta "Warszawa"
- Zwraca sumę tylko dla Warszawy
![[Pasted image 20251209172007.png]]


---

### Przykład 2: Wiele filtrów

```dax
Sprzedaż VIP w 2024 = 
CALCULATE(
    SUM(Sprzedaz[Kwota]),
    Klienci[Kategoria] = "VIP",
    YEAR(Sprzedaz[Data]) = 2024
)
```

**Filtry są łączone operatorem AND** – muszą być **oba** spełnione.

![[Pasted image 20251209172247.png]]

---

### Przykład 3: Nadpisanie istniejącego filtra
A co jeżeli chcemy policzyć udział sprzedaży w sprzedaży ogółem?
- Jeżeli nałożymy na wizualizację kolumnę, tworzy ona kontekst filtra/kolumny
- Do pozbycia się kontekstu służy funkcja `REMOVEFILTERS()`

```dax
Sprzedaż Netto - Cały Okres = 
CALCULATE(
    [Sprzedaż Netto], 
    REMOVEFILTERS(dKalendarz)
)
```

**Co robi `REMOVEFILTERS`?**
- Usuwa filtry z kolumny `dKalendarz`
- Dzięki temu `Całkowita Sprzedaż` pokazuje sumę dla **wszystkich dni**, niezależnie od tego, jaki kontekst **Kalendarza** zostanie nałożony na wizualizację

> **Ciekawostka:** Funkcję `REMOVEFILTERS()` można używać zamiennie z funkcją `ALL()`. W tym 

---

## Kiedy używać CALCULATE?

✅ **Używaj CALCULATE gdy:**

- Chcesz dodać **dodatkowy filtr** do obliczeń
- Chcesz **nadpisać** istniejący filtr
- Chcesz obliczyć wartość w **innym kontekście** niż aktualny (np. suma całkowita)
- Chcesz porównać wartości (np. sprzedaż bieżącego roku vs poprzedniego)

---

### Przykład praktyczny: Udział w sprzedaży

```dax
Udział w Sprzedaży = 
DIVIDE(
    SUM(Sprzedaz[Kwota]),
    CALCULATE(
        SUM(Sprzedaz[Kwota]),
        ALL(Produkty[Kategoria])
    )
)
```

**Jak to działa:**

- **Licznik:** Suma sprzedaży dla aktualnej kategorii (np. "Elektronika")
- **Mianownik:** Suma sprzedaży dla **wszystkich** kategorii (dzięki `ALL`)
- **Wynik:** Procent sprzedaży danej kategorii względem całości

---

### Przykład: Porównanie z poprzednim rokiem

```dax
Sprzedaż Poprzedni Rok = 
CALCULATE(
    SUM(Sprzedaz[Kwota]),
    SAMEPERIODLASTYEAR(Kalendarz[Data])
)
```

**Co się dzieje:**

- `SAMEPERIODLASTYEAR` przesuwa kontekst dat o rok wstecz
- Dzięki temu `CALCULATE` oblicza sprzedaż dla **tego samego okresu rok temu**

---

## Kluczowe zasady CALCULATE

1. **CALCULATE zmienia kontekst filtrowania** – to jego główna rola
2. **Filtry w CALCULATE są stosowane jako AND** – wszystkie muszą być spełnione
3. **CALCULATE może nadpisać istniejące filtry** – nowy filtr zastępuje stary
4. **CALCULATE działa tylko w miarach** – nie w kolumnach kalkulowanych (tam kontekst jest inny)

---

## Podsumowanie CALCULATE

**CALCULATE** to fundament zaawansowanych obliczeń w DAX:

- Pozwala tworzyć **dynamiczne miary**
- Umożliwia **porównania** między różnymi okresami/kategoriami
- Daje kontrolę nad **kontekstem filtrowania**
- Jest podstawą funkcji time intelligence (SAMEPERIODLASTYEAR, DATEADD, itd.)

**Zapamiętaj:** Jeśli chcesz obliczyć coś w **innym kontekście** niż aktualny, prawdopodobnie potrzebujesz **CALCULATE**.
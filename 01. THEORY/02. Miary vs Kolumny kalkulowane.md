# Kolumny vs. Miary
## Dwa podejścia do DAX

Jedną z najważniejszych rzeczy do zrozumienia w DAX jest różnica między **miarami** a **kolumnami kalkulowanymi**. Choć obie używają formuł DAX, działają zupełnie inaczej i wymagają **odmiennego podejścia do pisania kodu**.

## Kolumny kalkulowane (Calculated Columns)

**Kolumna kalkulowana** to nowa kolumna dodana do tabeli, której wartość jest obliczana **wiersz po wierszu** (tzw. kontekst wiersza) w momencie odświeżania danych.

### Charakterystyka kolumn kalkulowanych:

- Obliczane **podczas ładowania/odświeżania danych**
- Wartość obliczana **dla każdego wiersza** w tabeli
- Wynik jest **przechowywany** w modelu (zajmuje miejsce w pamięci)
- Można ich używać do **filtrowania**, **grupowania** lub **sortowania**
- Używają **kontekstu wiersza** (row context)

### Przykład kolumny kalkulowanej:

```dax
Cena Jednostkowa =
Sprzedaż[Wartość netto] / Sprzedaż[Ilość]
```

**Co się dzieje:**

- Formuła jest obliczana **dla każdego wiersza** w tabeli Sprzedaż
- Jeśli masz 1000 wierszy, otrzymasz 1000 wartości
- Wartości są zapisane w modelu i widoczne w widoku danych
- Możesz użyć tej kolumny w slicerach, filtrach lub do sortowania

### Podejście do pisania DAX w kolumnach

**W kolumnach możesz operować na kolumnach jak na zmiennych:**

```dax
// ✅ W KOLUMNACH - bezpośrednie odwołania do kolumn
Marża PLN = Sprzedaż[Wartość netto] - Sprzedaż[Koszt]

Marża % = 
DIVIDE(
    Sprzedaż[Wartość netto] - Sprzedaż[Koszt],
    Sprzedaż[Wartość netto]
)

Cena z VAT = Sprzedaż[Cena netto] * 1.23

Kategoria cenowa = 
IF(
    Sprzedaż[Wartość netto] > 1000,
    "Premium",
    "Standard"
)
```

**Możesz:**

- ✓ Odwoływać się bezpośrednio do kolumn: `Tabela[Kolumna]`
- ✓ Używać standardowych operatorów: `+`, `-`, `*`, `/`
- ✓ Mnożyć, dzielić, dodawać kolumny jak w Excelu
- ✓ Używać funkcji logicznych: `IF`, `SWITCH`
- ✓ Odwoływać się do innych kolumn kalkulowanych w tej samej tabeli

**Kiedy używać kolumn kalkulowanych:**

- Potrzebujesz wartości do **filtrowania** lub **grupowania**
- Chcesz **posortować** dane według obliczonej wartości
- Wartość zależy **tylko od danych w bieżącym wierszu**
- Przykład: kategoria cenowa produktu, wiek klienta, dzień tygodnia, rabat procentowy

---

## Miary (Measures)

**Miara** to formuła, która oblicza się **dynamicznie** w zależności od kontekstu filtrów w raporcie.

### Charakterystyka miar:

- Obliczane **w momencie wyświetlania** w wizualizacji
- Nie są przechowywane w modelu (nie zajmują miejsca)
- Wynik zależy od **kontekstu filtrów** na wizualizacji
- **Nie można** ich użyć do filtrowania wierszy
- Używają **kontekstu filtrów** (filter context)

### Przykład miary:

```dax
Sprzedaż Netto = SUM(Sprzedaż[Wartość netto])
```

**Co się dzieje:**

- Formuła oblicza sumę **w zależności od kontekstu**
- Na wykresie według kategorii: pokaże sumę dla każdej kategorii
- Na wykresie według regionu: pokaże sumę dla każdego regionu
- Bez filtrów: pokaże sumę całkowitą
- Wartość **nie jest przechowywana**, tylko obliczana na żądanie

### Podejście do pisania DAX w miarach

**W miarach MUSISZ używać funkcji agregujących:**

```dax
// ❌ ZŁE - nie zadziała w miarze
Marża PLN = Sprzedaż[Wartość netto] - Sprzedaż[Koszt]

// ✅ DOBRE - w miarach używamy funkcji agregujących
Marża PLN = 
SUM(Sprzedaż[Wartość netto]) - SUM(Sprzedaż[Koszt])

// ❌ ZŁE - próba mnożenia kolumn
Wartość z VAT = Sprzedaż[Wartość netto] * 1.23

// ✅ DOBRE - suma z mnożnikiem
Wartość z VAT = SUM(Sprzedaż[Wartość netto]) * 1.23

// ❌ ZŁE - bezpośrednie dzielenie kolumn
Marża % = 
(Sprzedaż[Wartość netto] - Sprzedaż[Koszt]) / Sprzedaż[Wartość netto]

// ✅ DOBRE - dzielenie zagregowanych wartości
Marża % = 
DIVIDE(
    SUM(Sprzedaż[Wartość netto]) - SUM(Sprzedaż[Koszt]),
    SUM(Sprzedaż[Wartość netto])
)
```

**W miarach:**

- ❌ **NIE MOŻESZ** bezpośrednio mnożyć/dzielić kolumn
- ❌ **NIE MOŻESZ** używać `Tabela[Kolumna]` bez funkcji agregującej
- ✅ **MUSISZ** najpierw zagregować: `SUM()`, `AVERAGE()`, `COUNT()`, itp.
- ✅ Dopiero **zagregowane wartości** możesz mnożyć, dzielić, dodawać

**Kiedy używać miar:**

- Potrzebujesz **agregacji** (suma, średnia, liczba)
- Wynik ma zależeć od **filtrów w raporcie**
- Chcesz **dynamicznych obliczeń** (procent udziału, porównania okresów)
- Przykład: suma sprzedaży, średnia wartość, liczba transakcji

---

## Porównanie: Kolumna kalkulowana vs Miara

|Aspekt|Kolumna kalkulowana|Miara|
|---|---|---|
|**Kiedy obliczana**|Podczas odświeżania danych|Podczas wyświetlania wizualizacji|
|**Kontekst**|Kontekst wiersza (row context)|Kontekst filtrów (filter context)|
|**Składnia DAX**|Bezpośrednie odwołania do kolumn|Wymagane funkcje agregujące|
|**Operacje na kolumnach**|Możesz mnożyć/dzielić kolumny bezpośrednio|Musisz najpierw zagregować, potem mnożyć/dzielić|
|**Przechowywanie**|Tak - zajmuje miejsce w pamięci|Nie - obliczana na żądanie|
|**Użycie w slicerach**|Tak|Nie|
|**Użycie w wizualizacjach**|Jako pole do grupowania|Jako wartość do agregacji|
|**Ikona w Power BI**|Ikona tabeli (⚏)|Ikona kalkulatora (fx)|

---

# Różnice podejśc
## Kluczowa różnica w podejściu do DAX

### W kolumnach: "Myśl wierszami"

```dax
// Pracujesz na JEDNYM wierszu naraz
// Możesz traktować kolumny jak zmienne

Rabat Kwotowy = Sprzedaż[Cena] * Sprzedaż[Procent rabatu]

Wartość końcowa = Sprzedaż[Cena] - Sprzedaż[Rabat Kwotowy]

Kategoria = 
SWITCH(
    TRUE(),
    Sprzedaż[Wartość] < 100, "Niska",
    Sprzedaż[Wartość] < 500, "Średnia",
    "Wysoka"
)
```

### W miarach: "Myśl agregacją"
- Pracujesz na ZBIORZE wierszy
- Musisz najpierw zagregować, potem obliczać


```dax
// ❌ To nie zadziała:
Rabat Kwotowy = Sprzedaż[Cena] * Sprzedaż[Procent rabatu]

// ✅ Tak trzeba:
Rabat Kwotowy = SUMX(Sprzedaż, Sprzedaż[Cena] * Sprzedaż[Procent rabatu])
// lub
Rabat Kwotowy = SUM(Sprzedaż[Cena]) * AVERAGE(Sprzedaż[Procent rabatu])

// ❌ To nie zadziała:
Wartość końcowa = Sprzedaż[Cena] - Sprzedaż[Rabat]

// ✅ Tak trzeba:
Wartość końcowa = SUM(Sprzedaż[Cena]) - SUM(Sprzedaż[Rabat])
```

---

## Praktyczny przykład różnicy

### Scenariusz: Obliczenie marży

**Tabela Sprzedaż:**

| Produkt | Wartość netto | Koszt |
| ------- | ------------- | ----- |
| A       | 1000          | 600   |
| B       | 2000          | 1400  |
| C       | 500           | 350   |

### Jako kolumna kalkulowana:

```dax
Marża PLN = Sprzedaż[Wartość netto] - Sprzedaż[Koszt]
```

**Wynik w tabeli:**

|Produkt|Wartość netto|Koszt|Marża PLN|
|---|---|---|---|
|A|1000|600|**400**|
|B|2000|1400|**600**|
|C|500|350|**150**|

- Obliczona dla **każdego wiersza** osobno
- Wartości zapisane w modelu
- Możesz filtrować: "pokaż produkty gdzie Marża PLN > 500"

### Jako miara:

```dax
Marża PLN = SUM(Sprzedaż[Wartość netto]) - SUM(Sprzedaż[Koszt])
```

**Wynik na wizualizacji:**

- Bez filtrów: **1150** (suma wszystkich marż)
- Dla produktu A: **400**
- Dla produktu B: **600**
- Według kategorii: suma marż w każdej kategorii
- Obliczana **dynamicznie** według kontekstu
- Nie zajmuje miejsca w pamięci
- **Nie możesz** filtrować wierszy według tej wartości
    

---

## Najczęstsze błędy początkujących

### Błąd 1: Tworzenie kolumny zamiast miary dla agregacji

```dax
// ❌ ZŁE - kolumna kalkulowana (niepotrzebnie zajmuje pamięć)
Suma Wartości Kolumna = SUM(Sprzedaż[Wartość netto])

// ✅ DOBRE - miara (dynamiczna, nie zajmuje pamięci)
Suma Wartości Miara = SUM(Sprzedaż[Wartość netto])
```

### Błąd 2: Próba mnożenia kolumn w miarze

```dax
// ❌ ZŁE - nie zadziała w miarze
Wartość Brutto = Sprzedaż[Wartość netto] * 1.23

// ✅ DOBRE - agreguj najpierw
Wartość Brutto = SUM(Sprzedaż[Wartość netto]) * 1.23

// ✅ ALBO użyj SUMX dla wiersz-po-wierszu
Wartość Brutto = SUMX(Sprzedaż, Sprzedaż[Wartość netto] * 1.23)
```

### Błąd 3: Zapominanie o agregacji w miarach

```dax
// ❌ ZŁE - w miarze musisz agregować
Średnia Cena = Sprzedaż[Wartość netto] / Sprzedaż[Ilość]

// ✅ DOBRE opcja 1 - zagregowane dzielenie
Średnia Cena = 
DIVIDE(
    SUM(Sprzedaż[Wartość netto]),
    SUM(Sprzedaż[Ilość])
)

// ✅ DOBRE opcja 2 - iteracyjne obliczenie średniej
Średnia Cena = 
AVERAGEX(
    Sprzedaż,
    DIVIDE(Sprzedaż[Wartość netto], Sprzedaż[Ilość])
)
```

---

## Kiedy używać czego? - Decyzja

**Użyj kolumny kalkulowanej gdy:**

- ✓ Potrzebujesz wartości do **filtrowania** (slicer, filtr)
- ✓ Chcesz **grupować** według obliczonej wartości
- ✓ Wartość zależy tylko od **bieżącego wiersza**
- ✓ Możesz zapisać DAX **bez funkcji agregujących**
- ✓ Przykład: "Kategoria wiekowa klienta", "Dzień tygodnia sprzedaży", "Rabat kwotowy"

**Użyj miary gdy:**

- ✓ Potrzebujesz **agregacji** (suma, średnia, liczba)
- ✓ Wynik ma być **dynamiczny** (zależny od filtrów)
- ✓ Chcesz **oszczędzić pamięć** w modelu
- ✓ W formule używasz `SUM()`, `AVERAGE()`, `COUNT()`, itp.
- ✓ Przykład: "Suma sprzedaży", "Liczba transakcji", "Średnia wartość", "% udział"

---

## Złota zasada

> **Jeśli w formule używasz funkcji agregującej (`SUM`, `AVERAGE`, `COUNT`, itp.), prawie zawsze powinieneś tworzyć MIARĘ, nie kolumnę.**

> **Jeśli możesz napisać formułę bez agregacji, tylko prostym odwołaniem do kolumn (jak w Excelu), prawdopodobnie potrzebujesz KOLUMNY.**

---
---
type: teoria
---

## Czym są VAR i RETURN?

**VAR** i **RETURN** to kluczowe słowa w języku DAX, które pozwalają na tworzenie **zmiennych** i **zwracanie wyników** w miarach i kolumnach kalkulowanych.

### VAR (Variable)
- Służy do **deklarowania zmiennych** i przechowywania w nich wartości
- Zmienne mogą zawierać: liczby, teksty, tabele, wyniki obliczeń
- Zmienne są **obliczane tylko raz** i przechowują swoją wartość
- Pomagają **unikać powtarzania** tego samego kodu
- Poprawiają **czytelność** i **wydajność** miar

### RETURN
- **Zwraca wynik** całego wyrażenia DAX
- W mierze/kolumnie może być **tylko jedno RETURN**
- To, co umieścisz po RETURN, stanie się **końcowym wynikiem**

---

## Podstawowa składnia

```dax
NazwaMiary = 
VAR NazwaZmiennej1 = <wyrażenie1>
VAR NazwaZmiennej2 = <wyrażenie2>
VAR NazwaZmiennej3 = <wyrażenie3>
RETURN <wynik_końcowy>
```

**Przykład prosty:**

```dax
Całkowity Koszt = 
VAR IloscSztuk = 100
VAR CenaJednostkowa = 25
VAR Koszt = IloscSztuk * CenaJednostkowa
RETURN Koszt
```

Wynik: **2500**

---

## Jak to działa w funkcjach iteracyjnych (SUMX, FILTER, itd.)?

W funkcjach iteracyjnych jak **SUMX**, **FILTER**, **ADDCOLUMNS** zmienne VAR są **przetwarzane w każdej iteracji**:

**Zasada:** Dla każdego wiersza tabeli, zmienne VAR są **obliczane na nowo** z wartościami z aktualnego wiersza.


```dax
SUMX(
    {1, 2, 3},  -- Iterujemy po wartościach 1, 2, 3
    VAR Kwadrat = [Value] * [Value] -- [Value] to domyślna nazwa utworzonej kolumny
    RETURN Kwadrat
)
```

## Kroki algorytmu:

### Iteracja 1: [Value] = 1

- `Kwadrat` = 1 × 1 = **1**
- RETURN zwraca: **1**

### Iteracja 2: [Value] = 2

- `Kwadrat` = 2 × 2 = **4**
- RETURN zwraca: **4**

### Iteracja 3: [Value] = 3

- `Kwadrat` = 3 × 3 = **9**
- RETURN zwraca: **9**


SUMX dodaje wszystkie zwrócone wartości: 1 + 4 + 9 = **14**

W każdej iteracji zmienna `Kwadrat` jest **tworzona od nowa** z nową wartością! Nie jest to ta sama zmienna — każda iteracja ma własny "kontekst wiersza" i własne wartości zmiennych.

**To oznacza:**
- Zmienne VAR wewnątrz iteracji są **dynamiczne**
- Dostosowują się do **aktualnego wiersza** w tabeli
- Pozwalają na **elastyczne obliczenia** dla każdego elementu z osobna

---
## Odchylenie od średniej

```dax
Suma Odchyleń od Średniej = 
VAR Srednia = AVERAGE({1, 2, 3, 4, 5})  -- Obliczona raz: 3
RETURN
    SUMX(
        {1, 2, 3},
        VAR Wartosc = [Value]
        VAR Odchylenie = Wartosc - Srednia  -- Używamy zmiennej spoza iteracji!
        RETURN Odchylenie
    )
```

### Co się dzieje krok po kroku:

### Przed iteracją:

- `Srednia` = (1 + 2 + 3) / 3 = 2 ← obliczone **tylko raz**

### Iteracja 1: [Value] = 1

- `Wartosc` = 1
- `Odchylenie` = 1 - 3 = **-2**
- RETURN zwraca: **-2**

### Iteracja 2: [Value] = 2

- `Wartosc` = 2
- `Odchylenie` = 2 - 3 = **-1**
- RETURN zwraca: **-1**

### Iteracja 3: [Value] = 3

- `Wartosc` = 3
- `Odchylenie` = 3 - 3 = **0**
- RETURN zwraca: **0**


### Suma końcowa:
SUMX dodaje wszystkie odchylenia: (-2) + (-1) + 0 = **-3**

---
# Query View

**Query View** to specjalny tryb w Power BI Desktop (dostępny w External Tools lub przez DAX Studio), który pozwala wykonywać zapytania DAX bezpośrednio na modelu danych. W przeciwieństwie do zwykłych miar, które działają w kontekście wizualizacji, Query View umożliwia pisanie zapytań tabelarycznych z użyciem słowa kluczowego `EVALUATE` oraz definiowanie tymczasowych miar i zmiennych za pomocą `DEFINE`. Jest to narzędzie programistyczne do testowania logiki DAX, debugowania obliczeń i eksploracji danych bez konieczności tworzenia wizualizacji.

### VAR bez RETURN (błąd składniowy)

```dax
VAR A = 1
VAR B = 5
A + B
```

**Status:** ❌ **To jest niepoprawne!**

- Zmienne `VAR` **zawsze muszą być zakończone słowem kluczowym `RETURN`**
- DAX nie wie, co ma zwrócić jako wynik
- Ten kod spowoduje błąd składniowy

```dax
EVALUATE
    VAR A = 1
    VAR B = 5
RETURN
A + B
```

**Status:** ❌ **Blisko, ale wciąż źle!**
- DAX potrafi zwracać wyłącznie wartości tabelaryczne. A + B zwraca pojedynczą wartość
- Należy utworzyć "sztuczną" tabelę (np. z funkcją `ROW()`), albo podsumować według istniejących kolumn za pomocą `SUMMARIZECOLUMNS()` ``

---

### VAR z RETURN w zapytaniu EVALUATE

```dax
EVALUATE
    VAR A = 1
    VAR B = 5
RETURN
    ROW("Test", A + B)
```

**Status:** ✅ **Poprawne**

- Zmienne `A` i `B` są tworzone **przed** wykonaniem właściwego zapytania
- `RETURN` zwraca tabelę z jednym wierszem i jedną kolumną o nazwie "Test"
- Wartość w kolumnie to wynik `A + B` = 6

**Wynik zapytania:**

|Test|
|---|
|6|

---

### VAR wewnątrz definicji miary

```dax
DEFINE MEASURE _Measures[Test] = 
    VAR A = 1
    VAR B = 5
RETURN
    A + B
	
EVALUATE
    ROW("Test", [Test])
```

**Status:** ✅ **Poprawne**

- Zmienne `VAR` są zdefiniowane **wewnątrz miary** `[Test]`
- Za każdym razem gdy miara jest wywoływana, zmienne są tworzone na nowo
- Miara zwraca wartość `A + B` = 6
- `EVALUATE` wywołuje miarę i wyświetla jej wynik w tabeli

---

## Zastosowanie

Query View i zapytania DAX znajdują zastosowanie w kilku kluczowych scenariuszach:

- **Testowanie i debugowanie** – szybkie sprawdzanie logiki DAX bez tworzenia wizualizacji
- **Eksploracja modelu danych** – przeglądanie zawartości tabel, relacji i wyników obliczeń
- **Prototypowanie miar** – testowanie skomplikowanych formuł przed wdrożeniem do raportu
- **Analiza wydajności** – mierzenie czasu wykonania zapytań i optymalizacja modelu
- **Eksport danych** – pobieranie wyników zapytań do dalszej analizy w innych narzędziach
- **Dokumentacja** – tworzenie przykładów działania miar dla zespołu lub klientów

![[Pasted image 20251209181932.png]]
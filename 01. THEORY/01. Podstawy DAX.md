## Czym jest DAX?

**DAX (Data Analysis Expressions)** to język formuł używany w Power BI, Excel Power Pivot i Analysis Services do tworzenia:

- **Miar** (measures) – dynamicznych obliczeń
- **Kolumn kalkulowanych** – stałych wartości w tabelach
- **Tabel kalkulowanych** – nowych tabel powstałych z obliczeń

DAX pozwala na analizę danych, tworzenie raportów i budowanie zaawansowanej logiki biznesowej.

---

## Odwoływanie się do tabel i kolumn

### Podstawowa składnia: NazwaTabeli[NazwaKolumny]

W DAX zawsze odwołujesz się do kolumn poprzez **nazwę tabeli** i **nazwę kolumny** w nawiasach kwadratowych:

```dax
Sprzedaz[Kwota]
Produkty[Kategoria]
Klienci[Miasto]
```

**Zasady:**

- Nazwa tabeli **przed** nawiasem kwadratowym
- Nazwa kolumny **w** nawiasach kwadratowych
- To zapobiega niejednoznaczności gdy masz kolumny o tych samych nazwach w różnych tabelach

---

### Nazwy z apostrofami (gdy zawierają spacje lub znaki specjalne)

Jeśli nazwa tabeli lub kolumny zawiera:

- Spacje
- Znaki specjalne (np. `-`, `#`, `%`)
- Polskie znaki

Musisz ująć je w **apostrofy** `'`:

```dax
'Tabela Sprzedaży'[Kwota Netto]
'Dane-Produktów'[Nazwa Produktu]
'2024 Wyniki'[Przychód]
Produkty[Cena (netto)]
```

**Przykład błędny:**

```dax
Tabela Sprzedaży[Kwota Netto]  -- ❌ Błąd składni!
```

**Przykład poprawny:**

```dax
'Tabela Sprzedaży'[Kwota Netto]  -- ✅ Działa
```

---

### Odwoływanie się do miar: [NazwaMiary]

Miary (measures) odwołujesz się **bez nazwy tabeli**, tylko w nawiasach kwadratowych:

```dax
[Suma Sprzedaży]
[Średnia Cena]
[Liczba Klientów]
```

Możesz też użyć pełnej notacji z nazwą tabeli, ale nie jest to wymagane:

```dax
Sprzedaz[Suma Sprzedaży]  -- Działa, ale zwykle niepotrzebne
```

---

### Pełna nazwa tabeli (gdy jest w innym modelu)

Jeśli pracujesz z wieloma modelami danych, możesz użyć pełnej ścieżki:

```dax
'Nazwa Modelu'[Nazwa Tabeli][Nazwa Kolumny]
```

W większości przypadków wystarczy standardowa notacja `Tabela[Kolumna]`.

---

## Typy danych w DAX

DAX obsługuje kilka podstawowych typów danych:

| Typ                   | Przykład                           | Opis                    |
| --------------------- | ---------------------------------- | ----------------------- |
| **Liczby całkowite**  | `100`, `-50`                       | Integer                 |
| **Liczby dziesiętne** | `123.45`, `0.99`                   | Decimal/Float           |
| **Tekst**             | `"Warszawa"`, `"ABC"`              | String (w cudzysłowach) |
| **Data**              | `DATE(2024, 12, 8)`                | Date                    |
| **Data i czas**       | `DATETIME(2024, 12, 8, 14, 30, 0)` | DateTime                |
| **Logiczne**          | `TRUE`, `FALSE`                    | Boolean                 |
| **Puste**             | `BLANK()`                          | Null/Empty              |

---

## Operatory matematyczne

```dax
+   -- Dodawanie
-   -- Odejmowanie
*   -- Mnożenie
/   -- Dzielenie
^   -- Potęgowanie
```

**Przykład:**

```dax
Marża = 
Sprzedaz[Przychód] - Sprzedaz[Koszt]
```

---

## Operatory porównania

```dax
=   -- Równe
<>  -- Różne od
>   -- Większe niż
<   -- Mniejsze niż
>=  -- Większe lub równe
<=  -- Mniejsze lub równe
```

**Przykład:**

```dax
Czy Duża Sprzedaż = 
Sprzedaz[Kwota] > 1000
```

---

## Operatory logiczne

```dax
&&  -- AND (i)
||  -- OR (lub)
NOT -- NOT (negacja)
```

**Przykład:**

```dax
Czy Premium = 
Klienci[Kategoria] = "VIP" && Klienci[Przychód] > 10000
```

---

## Operator łączenia tekstów

```dax
&   -- Konkatenacja (łączenie tekstów)
```

**Przykład:**

```dax
Pełna Nazwa = 
Klienci[Imię] & " " & Klienci[Nazwisko]
```

---

#  Funkcje agregujące

## SUM – Suma wartości

Sumuje wszystkie wartości w kolumnie:

```dax
Suma Sprzedaży = SUM(Sprzedaz[Kwota])
```

**Jak działa:**

- Dodaje wszystkie liczby w kolumnie `Sprzedaz[Kwota]`
- Pomija wartości `BLANK()` (puste)
- Uwzględnia aktualny kontekst filtrowania

---

## AVERAGE – Średnia

Oblicza średnią arytmetyczną:

```dax
Średnia Cena = AVERAGE(Produkty[Cena])
```

**Jak działa:**

- Sumuje wszystkie wartości i dzieli przez ich liczbę
- Pomija wartości puste

---

## COUNT – Liczba wartości niepustych

Liczy ile jest niepustych wartości w kolumnie:

```dax
Liczba Transakcji = COUNT(Sprzedaz[ID Transakcji])
```

**Uwaga:** COUNT liczy tylko wartości **niepuste** (pomija BLANK).

---

## COUNTA – Liczba wartości niepustych (dowolny typ)

Podobnie jak COUNT, ale działa na **wszystkich typach danych** (tekst, liczby, daty):

```dax
Liczba Produktów = COUNTA(Produkty[Nazwa])
```

---

## COUNTROWS – Liczba wierszy w tabeli

Liczy wszystkie wiersze w tabeli (nawet jeśli mają puste wartości):

```dax
Liczba Zamówień = COUNTROWS(Zamowienia)
```

**Różnica COUNT vs COUNTROWS:**

- `COUNT` – liczy niepuste wartości w **konkretnej kolumnie**
- `COUNTROWS` – liczy **wszystkie wiersze w tabeli**

---

## MIN i MAX – Minimum i maksimum

```dax
Najniższa Cena = MIN(Produkty[Cena])
Najwyższa Cena = MAX(Produkty[Cena])
```

---

## DISTINCTCOUNT – Liczba unikalnych wartości

Liczy ile jest **unikalnych** (niepowtarzających się) wartości:

```dax
Liczba Unikalnych Klientów = DISTINCTCOUNT(Sprzedaz[ID Klienta])
```

**Przykład:** Jeśli kolumna zawiera: `{1, 2, 2, 3, 3, 3}`, to `DISTINCTCOUNT` zwróci **3**.

---

#  Funkcje logiczne

## IF – Warunek logiczny

Zwraca jedną wartość jeśli warunek jest prawdziwy, inną jeśli fałszywy:

```dax
IF(<warunek>, <wartość_jeśli_prawda>, <wartość_jeśli_fałsz>)
```

**Przykład:**

```dax
Kategoria Sprzedaży = 
IF(
    Sprzedaz[Kwota] > 1000,
    "Wysoka",
    "Niska"
)
```

---

## AND – Sprawdza czy wszystkie warunki są prawdziwe

```dax
AND(<warunek1>, <warunek2>)
```

**Przykład:**

```dax
Czy VIP = 
IF(
    AND(Klienci[Przychód] > 50000, Klienci[Lata Współpracy] > 5),
    "TAK",
    "NIE"
)
```

---

## OR – Sprawdza czy przynajmniej jeden warunek jest prawdziwy

```dax
OR(<warunek1>, <warunek2>)
```

**Przykład:**

```dax
Czy Promocja = 
IF(
    OR(Produkty[Kategoria] = "Elektronika", Produkty[Wyprzedaż] = TRUE),
    "TAK",
    "NIE"
)
```

---

## NOT – Negacja warunku

```dax
NOT(<warunek>)
```

**Przykład:**

```dax
Czy Nieaktywny = 
IF(
    NOT(Klienci[Status] = "Aktywny"),
    "TAK",
    "NIE"
)
```

---

#  Funkcje tekstowe

## CONCATENATE – Łączenie tekstów

```dax
CONCATENATE(<tekst1>, <tekst2>)
```

**Przykład:**

```dax
Pełna Nazwa = CONCATENATE(Klienci[Imię], " " & Klienci[Nazwisko])
```

**Alternatywa (łatwiejsza):**

```dax
Pełna Nazwa = Klienci[Imię] & " " & Klienci[Nazwisko]
```

---

## LEFT, RIGHT, MID – Wyciąganie części tekstu

```dax
LEFT(<tekst>, <liczba_znaków>)    -- Pierwsze znaki od lewej
RIGHT(<tekst>, <liczba_znaków>)   -- Ostatnie znaki od prawej
MID(<tekst>, <start>, <liczba>)   -- Znaki ze środka
```

**Przykład:**

```dax
Pierwsze 3 Znaki = LEFT(Produkty[Kod], 3)
Ostatnie 2 Znaki = RIGHT(Produkty[Kod], 2)
```

---

## UPPER, LOWER – Zmiana wielkości liter

```dax
UPPER(<tekst>)  -- Wszystkie znaki WIELKIE
LOWER(<tekst>)  -- Wszystkie znaki małe
```

**Przykład:**

```dax
Kategoria Wielkie Litery = UPPER(Produkty[Kategoria])
```

---

## LEN – Długość tekstu

```dax
LEN(<tekst>)
```

**Przykład:**

```dax
Długość Kodu = LEN(Produkty[Kod Produktu])
```

---

#  Funkcje dat

## DATE – Tworzenie daty

```dax
DATE(<rok>, <miesiąc>, <dzień>)
```

**Przykład:**

```dax
Data Bazowa = DATE(2024, 1, 1)
```

---

## TODAY i NOW – Dzisiejsza data

```dax
TODAY()     -- Dzisiejsza data (bez godziny)
NOW()       -- Dzisiejsza data i godzina
```

**Przykład:**

```dax
Aktualna Data = TODAY()
```

---

## YEAR, MONTH, DAY – Wyciąganie składników daty

```dax
YEAR(<data>)   -- Rok
MONTH(<data>)  -- Miesiąc (1-12)
DAY(<data>)    -- Dzień (1-31)
```

**Przykład:**

```dax
Rok Sprzedaży = YEAR(Sprzedaz[Data])
Miesiąc Sprzedaży = MONTH(Sprzedaz[Data])
```

---

## DATEDIFF – Różnica między datami

```dax
DATEDIFF(<data_początkowa>, <data_końcowa>, <jednostka>)
```

**Jednostki:** DAY, MONTH, YEAR, QUARTER

**Przykład:**

```dax
Dni Od Zamówienia = 
DATEDIFF(Zamowienia[Data Zamówienia], TODAY(), DAY)
```

---

# Funkcje iteracyjne (X-functions)

Funkcje iteracyjne przechodzą przez **każdy wiersz tabeli** i wykonują obliczenia dla każdego wiersza osobno.

## SUMX – Suma z iteracją

```dax
SUMX(<tabela>, <wyrażenie>)
```

Dla każdego wiersza tabeli oblicza wyrażenie, potem sumuje wyniki.

**Przykład:**

```dax
Suma Wartości Zamówień = 
SUMX(
    Sprzedaz,
    Sprzedaz[Ilość] * Sprzedaz[Cena]
)
```

**Co się dzieje:**

- Dla każdego wiersza w tabeli `Sprzedaz` mnoży `Ilość * Cena`
- Potem sumuje wszystkie wyniki

---

## AVERAGEX – Średnia z iteracją

```dax
AVERAGEX(<tabela>, <wyrażenie>)
```

**Przykład:**

```dax
Średnia Marża = 
AVERAGEX(
    Sprzedaz,
    Sprzedaz[Przychód] - Sprzedaz[Koszt]
)
```

---

## COUNTX – Liczenie z iteracją

```dax
COUNTX(<tabela>, <wyrażenie>)
```

Liczy ile razy wyrażenie zwróciło **niepustą wartość**.

**Przykład:**

```dax
Liczba Zamówień Powyżej 1000 = 
COUNTX(
    Sprzedaz,
    IF(Sprzedaz[Kwota] > 1000, 1, BLANK())
)
```

---

## MINX i MAXX – Minimum i maksimum z iteracją

```dax
MINX(<tabela>, <wyrażenie>)
MAXX(<tabela>, <wyrażenie>)
```

**Przykład:**

```dax
Najwyższa Marża = 
MAXX(
    Sprzedaz,
    Sprzedaz[Przychód] - Sprzedaz[Koszt]
)
```

---

# Funkcje filtrujące

## FILTER – Filtrowanie tabeli

Zwraca **podzbiór tabeli** spełniający warunek:

```dax
FILTER(<tabela>, <warunek>)
```

**Przykład:**

```dax
Wysokie Sprzedaże = 
FILTER(
    Sprzedaz,
    Sprzedaz[Kwota] > 1000
)
```

**Użycie z SUMX:**

```dax
Suma Wysokich Sprzedaży = 
SUMX(
    FILTER(Sprzedaz, Sprzedaz[Kwota] > 1000),
    Sprzedaz[Kwota]
)
```

---

## CALCULATE – Modyfikacja kontekstu filtrowania

```dax
CALCULATE(<wyrażenie>, <filtr1>, <filtr2>, ...)
```

**CALCULATE** to **najważniejsza funkcja w DAX**. Pozwala:

- Zmienić kontekst filtrowania
- Dodać nowe filtry
- Nadpisać istniejące filtry
- Stworzyć obliczenia w różnych kontekstach

---

# Wprowadzenie do CALCULATE

## Czym jest kontekst filtrowania?

**Kontekst filtrowania** to zbiór filtrów aktywnych w danym momencie obliczeń. Określa on **jakie wiersze** z tabel są brane pod uwagę.

**Przykład:** Jeśli w wizualizacji masz slicer ustawiony na "Rok = 2024", to wszystkie miary widzą tylko dane z 2024 roku.

---

##  użycie CALCULATE

### Przykład 1: Dodanie filtra

```dax
Sprzedaż w Warszawie = 
CALCULATE(
    SUM(Sprzedaz[Kwota]),
    Klienci[Miasto] = "Warszawa"
)
```

**Co się dzieje:**

- Bierze `SUM(Sprzedaz[Kwota])`
- Dodaje filtr: tylko dla miasta "Warszawa"
- Zwraca sumę tylko dla Warszawy

---

### Przykład 2: Wiele filtrów

```dax
Sprzedaż VIP w 2024 = 
CALCULATE(
    SUM(Sprzedaz[Kwota]),
    Klienci[Kategoria] = "VIP",
    YEAR(Sprzedaz[Data]) = 2024
)
```

**Filtry są łączone operatorem AND** – muszą być **oba** spełnione.

---

### Przykład 3: Nadpisanie istniejącego filtra

```dax
Całkowita Sprzedaż = 
CALCULATE(
    SUM(Sprzedaz[Kwota]),
    ALL(Produkty[Kategoria])
)
```

**Co robi `ALL`?**

- Usuwa filtry z kolumny `Produkty[Kategoria]`
- Dzięki temu `Całkowita Sprzedaż` pokazuje sumę dla **wszystkich kategorii**, niezależnie od tego, co jest wybrane w slicerze

_(Funkcje ALL, ALLEXCEPT, REMOVEFILTERS omówimy w bardziej zaawansowanym materiale)_

---

## Kiedy używać CALCULATE?

✅ **Używaj CALCULATE gdy:**

- Chcesz dodać **dodatkowy filtr** do obliczeń
- Chcesz **nadpisać** istniejący filtr
- Chcesz obliczyć wartość w **innym kontekście** niż aktualny (np. suma całkowita)
- Chcesz porównać wartości (np. sprzedaż bieżącego roku vs poprzedniego)

---

### Przykład praktyczny: Udział w sprzedaży

```dax
Udział w Sprzedaży = 
DIVIDE(
    SUM(Sprzedaz[Kwota]),
    CALCULATE(
        SUM(Sprzedaz[Kwota]),
        ALL(Produkty[Kategoria])
    )
)
```

**Jak to działa:**

- **Licznik:** Suma sprzedaży dla aktualnej kategorii (np. "Elektronika")
- **Mianownik:** Suma sprzedaży dla **wszystkich** kategorii (dzięki `ALL`)
- **Wynik:** Procent sprzedaży danej kategorii względem całości

---

### Przykład: Porównanie z poprzednim rokiem

```dax
Sprzedaż Poprzedni Rok = 
CALCULATE(
    SUM(Sprzedaz[Kwota]),
    SAMEPERIODLASTYEAR(Kalendarz[Data])
)
```

**Co się dzieje:**

- `SAMEPERIODLASTYEAR` przesuwa kontekst dat o rok wstecz
- Dzięki temu `CALCULATE` oblicza sprzedaż dla **tego samego okresu rok temu**

---

## Kluczowe zasady CALCULATE

1. **CALCULATE zmienia kontekst filtrowania** – to jego główna rola
2. **Filtry w CALCULATE są stosowane jako AND** – wszystkie muszą być spełnione
3. **CALCULATE może nadpisać istniejące filtry** – nowy filtr zastępuje stary
4. **CALCULATE działa tylko w miarach** – nie w kolumnach kalkulowanych (tam kontekst jest inny)

---

## Podsumowanie CALCULATE

**CALCULATE** to fundament zaawansowanych obliczeń w DAX:

- Pozwala tworzyć **dynamiczne miary**
- Umożliwia **porównania** między różnymi okresami/kategoriami
- Daje kontrolę nad **kontekstem filtrowania**
- Jest podstawą funkcji time intelligence (SAMEPERIODLASTYEAR, DATEADD, itd.)

**Zapamiętaj:** Jeśli chcesz obliczyć coś w **innym kontekście** niż aktualny, prawdopodobnie potrzebujesz **CALCULATE**.